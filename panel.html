<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Panel Principal - Mar√≠a Chula</title>
  <link rel="stylesheet" href="panel.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="icon" href="fotos/iconomch.ico" type="image/x-icon">
</head>
<body>
<div class="app">
  <main class="main">
    <div class="header">
      <div class="title">Panel de Control - Mar√≠a Chula</div>
      <div class="actions">
        <div class="user-info">
          <i class="fas fa-user"></i>
          <span id="username">Administrador</span>
        </div>
        <button class="btn ghost" id="logoutBtn">
          <i class="fas fa-sign-out-alt"></i>Cerrar Sesi√≥n
        </button>
      </div>
    </div>

    <div class="card">
      <div class="options-container">
        <h1 class="page-title">Seleccione una opci√≥n del sistema</h1>
        
        <div class="edit-mode-message" id="editModeMessage">
          <i class="fas fa-info-circle"></i> Modo de edici√≥n activado: Arrastra y suelta para reordenar los m√≥dulos
        </div>
        
        <div class="options-grid" id="optionsGrid">
          <!-- Las opciones se cargar√°n din√°micamente desde JS -->
        </div>
      </div>
    </div>
    
    <button class="edit-mode-btn" id="editModeBtn">‚úèÔ∏è</button>
  </main>
</div>

<!-- Modal de confirmaci√≥n de cierre de sesi√≥n -->
<div class="modal" id="logoutModal">
  <div class="modal-content">
    <h2><i class="fas fa-sign-out-alt"></i> Cerrar Sesi√≥n</h2>
    <p>¬øEst√°s seguro de que deseas cerrar la sesi√≥n?</p>
    <div class="modal-buttons">
      <button class="btn ghost" id="cancelLogout">Cancelar</button>
      <button class="btn primary" id="confirmLogout">S√≠, Cerrar Sesi√≥n</button>
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    // Verificar token y sesi√≥n
    const token = localStorage.getItem('token');
    const currentUser = JSON.parse(localStorage.getItem('currentUser'));
  
    if (!token || !currentUser) {
      window.location.href = 'login.html';
      return;
    }
  
    // Mostrar nombre del usuario (fallback a "Usuario")
    document.getElementById('username').textContent =
      currentUser.nombre || currentUser.name || "Usuario";
  
    // Elementos del DOM
    const optionsGrid = document.getElementById('optionsGrid');
    const editModeBtn = document.getElementById('editModeBtn');
    const editModeMessage = document.getElementById('editModeMessage');
    const logoutBtn = document.getElementById('logoutBtn');
    const logoutModal = document.getElementById('logoutModal');
    const cancelLogout = document.getElementById('cancelLogout');
    const confirmLogout = document.getElementById('confirmLogout');
  
    let editMode = false;
    let draggedItem = null;
  
    // Opciones del sistema
    const systemOptions = [
      { id: 'menu', icon: 'üçΩÔ∏è', title: 'Men√∫', desc: 'Gesti√≥n de platos y productos', url: 'menu.html' },
      { id: 'inventory', icon: 'üì¶', title: 'Inventario', desc: 'Control de existencias', url: 'inventario.html' },
      { id: 'admin-menus', icon: 'üìù', title: 'Administraci√≥n de Men√∫s', desc: 'Configuraci√≥n de categor√≠as y platos', url: 'gestionar_menu.html' },
      { id: 'admin-users', icon: 'üë•', title: 'Administraci√≥n de usuarios', desc: 'Gesti√≥n de roles y permisos', url: 'gestionar_admin.html' },
      { id: 'factura', icon: 'üí∞', title: 'Facturaci√≥n', desc: 'Registro de ventas y cobros', url: 'factura.html' },
      { id: 'cash_register', icon: 'üè¶', title: 'Caja', desc: 'Control de efectivo y cortes', url: 'cash_register.html' },
      { id: 'eventos', icon: 'üéâ', title: 'Eventos', desc: 'Gesti√≥n de reservas y eventos', url: 'eventos.html' },
      { id: 'historial_eventos', icon: 'üìÖ', title: 'Historial de Eventos', desc: 'Registro de eventos pasados', url: 'historial_eventos.html' },
      { id: 'historial_pedidos', icon: 'üìã', title: 'Historial de Pedidos', desc: 'Consultar pedidos anteriores', url: 'historial_pedidos.html' },
      { id: 'cola_pedidos', icon: '‚è≥', title: 'Cola de pedidos', desc: 'Seguimiento de pedidos en curso', url: 'elige_cola.html' },
      { id: 'dashboard', icon: 'üìä', title: 'Dashboard', desc: 'Estad√≠sticas de los m√≥dulos', url: 'dashboard.html' },
      { id: 'clientes', icon: '', title: 'Clientes', desc: 'Informaci√≥n de los clientes', url: 'clientes.html'}
    ];
  
    // Cargar orden guardado
    function loadOptions() {
      const savedOrder = JSON.parse(localStorage.getItem('optionsOrder')) || [];
      const orderedOptions = [];
  
      systemOptions.forEach(option => {
        if (savedOrder.includes(option.id)) {
          orderedOptions[savedOrder.indexOf(option.id)] = option;
        } else {
          orderedOptions.push(option);
        }
      });
  
      const finalOptions = orderedOptions.filter(opt => opt).concat(
        systemOptions.filter(opt => !orderedOptions.includes(opt))
      );
  
      renderOptions(finalOptions);
    }
  
    // Renderizar opciones
    function renderOptions(options) {
      optionsGrid.innerHTML = '';
      options.forEach(option => {
        const optionCard = document.createElement('a');
        optionCard.className = 'option-card';
        optionCard.href = editMode ? 'javascript:void(0);' : option.url;
        optionCard.dataset.id = option.id;
        optionCard.innerHTML = `
          <div class="option-icon">${option.icon}</div>
          <h3>${option.title}</h3>
          <p>${option.desc}</p>
        `;
  
        if (editMode) {
          optionCard.draggable = true;
          optionCard.addEventListener('dragstart', handleDragStart);
          optionCard.addEventListener('dragover', handleDragOver);
          optionCard.addEventListener('drop', handleDrop);
          optionCard.addEventListener('dragend', handleDragEnd);
          optionCard.style.cursor = 'grab';
        } else {
          optionCard.draggable = false;
          optionCard.style.cursor = 'pointer';
        }
  
        optionsGrid.appendChild(optionCard);
      });
    }
  
    // Drag & drop
    function handleDragStart(e) {
      draggedItem = this;
      this.classList.add('dragging');
      e.dataTransfer.effectAllowed = 'move';
      e.dataTransfer.setData('text/html', this.innerHTML);
    }
    function handleDragOver(e) { e.preventDefault(); e.dataTransfer.dropEffect = 'move'; }
    function handleDrop(e) {
      e.preventDefault();
      if (draggedItem !== this) {
        const options = Array.from(optionsGrid.children);
        const draggedIndex = options.indexOf(draggedItem);
        const targetIndex = options.indexOf(this);
  
        if (draggedIndex < targetIndex) optionsGrid.insertBefore(draggedItem, this.nextSibling);
        else optionsGrid.insertBefore(draggedItem, this);
  
        saveOrder();
      }
    }
    function handleDragEnd() { this.classList.remove('dragging'); }
    function saveOrder() { 
      const newOrder = Array.from(optionsGrid.children).map(card => card.dataset.id);
      localStorage.setItem('optionsOrder', JSON.stringify(newOrder));
    }
  
    // Edit mode
    function toggleEditMode() {
      editMode = !editMode;
      editModeBtn.textContent = editMode ? 'üíæ' : '‚úèÔ∏è';
      editModeBtn.style.background = editMode ? 'var(--color-accent)' : 'var(--color-primary)';
      editModeMessage.style.display = editMode ? 'block' : 'none';
      loadOptions();
    }
    editModeBtn.addEventListener('click', toggleEditMode);
  
    // Logout
    function logout() {
      localStorage.removeItem('currentUser');
      localStorage.removeItem('token');
      window.location.href = 'login.html';
    }
    logoutBtn.addEventListener('click', () => { logoutModal.style.display = 'flex'; });
    cancelLogout.addEventListener('click', () => { logoutModal.style.display = 'none'; });
    confirmLogout.addEventListener('click', logout);
    logoutModal.addEventListener('click', e => { if (e.target === logoutModal) logoutModal.style.display = 'none'; });
  
    // Inicializar
    loadOptions();
  });
  </script>  
</body>
</html>