<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Men√∫ - Mar√≠a Chula</title>
  <link rel="stylesheet" href="menu.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="icon" href="fotos/iconomch.ico" type="image/x-icon">
</head>
<body>
<div class="app">
  <!-- Sidebar -->
  <aside class="sidebar">
    <div class="logo">
        <img src="fotos/logomch.png" alt="Logo Mar√≠a Chula">
        <h2>Mar√≠a Chula</h2>
    </div>
    <div class="menu-list">
      <a href="menu.html" class="menu-item active"><i class="fas fa-utensils"></i> Men√∫</a>
      <a href="inventory.html" class="menu-item"><i class="fas fa-boxes"></i> Inventario</a>
      <a href="dashboard.html" class="menu-item"><i class="fas fa-chart-bar"></i> Dashboard</a>
      <a href="admin-menus.html" class="menu-item"><i class="fas fa-list-alt"></i> Admin Men√∫s</a>
      <a href="admin-users.html" class="menu-item"><i class="fas fa-users"></i> Admin Usuarios</a>
      <a href="billing.html" class="menu-item"><i class="fas fa-receipt"></i> Facturaci√≥n</a>
      <a href="events.html" class="menu-item"><i class="fas fa-calendar-alt"></i> Eventos</a>
      <a href="history-events.html" class="menu-item"><i class="fas fa-history"></i> Historial Eventos</a>
      <a href="history-orders.html" class="menu-item"><i class="fas fa-clipboard-list"></i> Historial Pedidos</a>
      <a href="queue.html" class="menu-item"><i class="fas fa-tasks"></i> Cola de pedidos</a>
      <a href="cash-register.html" class="menu-item"><i class="fas fa-cash-register"></i> Caja Registradora</a>
    </div>
  </aside>
  <!-- Contenido principal -->
  <main class="main">
    <div class="header">
      <div class="title">Men√∫ de Pedidos</div>
      <div class="actions">
        <a href="panel.html" class="back-button">
          <i class="fas fa-arrow-left"></i> Regresar
        </a>
        <button id="cartButton" class="btn primary">
          <i class="fas fa-shopping-cart"></i> Ver Carrito (<span id="cartCount">0</span>)
        </button>
      </div>
    </div>
    <div class="card">
      <h3>Platos disponibles</h3>
      <div id="menuGrid" class="menu-grid"></div>
    </div>
  </main>
</div>
<!-- Modal del Carrito -->
<div id="cartModal" class="modal">
  <div class="modal-content" style="max-width:500px;">
    <div class="modal-header">
      <h3>Tu Pedido</h3>
      <button class="close-modal" onclick="closeCartModal()">&times;</button>
    </div>
    <div class="modal-body">
      <div id="cartItems"></div>
      <div id="emptyCart" class="empty-cart">No hay productos en el carrito</div>
      <div class="cart-total">Total: <span id="cartTotal">Q0.00</span></div>
      <h4 style="margin-top:15px;">Datos del Cliente</h4>
      <div id="clientForm"></div>
      <h4>Notas del pedido</h4>
      <textarea id="orderNotes" placeholder="Ejemplo: sin cebolla, con extra queso..."></textarea>
    </div>
    <div class="modal-footer">
      <button class="btn" onclick="closeCartModal()">Cancelar</button>
      <button class="btn primary" onclick="openOrderTypeModal()">Enviar pedido</button>
    </div>
  </div>
</div>
<!--  Modal para tipo de pedido -->
<div id="orderTypeModal" class="modal">
  <div class="modal-content" style="max-width:400px;">
    <div class="modal-header">
      <h3>Selecciona el tipo de pedido</h3>
      <button class="close-modal" onclick="closeOrderTypeModal()">&times;</button>
    </div>
    <div class="modal-body">
      <button class="btn" onclick="selectOrderType('mesa')">
        <i class="fas fa-utensils"></i> En mesa
      </button>
      <button class="btn primary" onclick="selectOrderType('domicilio')">
        <i class="fas fa-truck"></i> A domicilio
      </button>
    </div>
  </div>
</div>
<!-- Modal de mensajes -->
<div id="messageModal" class="modal">
  <div class="modal-content message-modal">
    <div class="modal-body" id="messageBody">
      <div id="messageIcon" class="message-icon"></div>
      <h3 id="messageTitle">Mensaje</h3>
      <p id="messageText"></p>
      <button class="btn primary" onclick="closeMessageModal()">Aceptar</button>
    </div>
  </div>
</div>
<!-- üîî Contenedor de notificaciones -->
<div id="toastContainer"></div>
<script>
let cart = [];
let orderNotes = "";
let orderType = null;

// ==============================
// TOAST
// ==============================
function showToast(mensaje, tipo = "info") {
  const container = document.getElementById("toastContainer");
  const toast = document.createElement("div");
  toast.className = `toast toast-${tipo}`;
  toast.innerHTML = `
    ${tipo === "success" ? "‚úÖ" : tipo === "warning" ? "‚ö†Ô∏è" : tipo === "error" ? "‚ùå" : "‚ÑπÔ∏è"} 
    ${mensaje}
  `;
  container.appendChild(toast);
  setTimeout(() => {
    toast.style.opacity = "0";
    setTimeout(() => toast.remove(), 300);
  }, 2500);
}

// ==============================
// MODAL DE MENSAJES
// ==============================
function showMessage(titulo, texto, tipo = "info") {
  const modal = document.getElementById("messageModal");
  const title = document.getElementById("messageTitle");
  const text = document.getElementById("messageText");
  const icon = document.getElementById("messageIcon");

  title.textContent = titulo;
  text.textContent = texto;

  const icons = { success: "‚úÖ", error: "‚ùå", warning: "‚ö†Ô∏è", info: "‚ÑπÔ∏è" };
  icon.textContent = icons[tipo] || "‚ÑπÔ∏è";

  modal.classList.add("active");
}

function closeMessageModal() {
  document.getElementById("messageModal").classList.remove("active");
}

// ==============================
// OBTENER MEN√ö
// ==============================
function getMenu() {
  const saved = localStorage.getItem("mc_menu");
  if (saved) return JSON.parse(saved);
  return [
    { id: 1, name: "Tacos al Pastor", description: "Carne adobada con pi√±a", price: 45, img: "fotos/no-image.png" },
    { id: 2, name: "Enchiladas Verdes", description: "Pollo con salsa verde", price: 55, img: "fotos/no-image.png" }
  ];
}

// ==============================
// RENDERIZAR MEN√ö
// ==============================
function renderMenuGrid() {
  const menu = getMenu();
  const grid = document.getElementById("menuGrid");

  if (!menu.length) {
    grid.innerHTML = `
      <div style="text-align:center; padding:40px; color:#888;">
        <i class="fas fa-utensils" style="font-size:48px;"></i>
        <p>No hay platillos en el men√∫</p>
        <a href="admin-menus.html" class="btn primary"><i class="fas fa-plus"></i> Agregar Platillos</a>
      </div>`;
    return;
  }

  grid.innerHTML = menu.map(item => `
    <div class="menu-item-card">
      <img src="${item.img || 'fotos/no-image.png'}" alt="${item.name}" class="menu-img">
      <h4>${item.name}</h4>
      <p>${item.description || ''}</p>
      <div class="price">Q${item.price.toFixed(2)}</div>
      <button class="btn primary" onclick="addToCart(${item.id})">
        <i class="fas fa-plus"></i> Agregar
      </button>
    </div>
  `).join("");
}

// ==============================
// CARRITO
// ==============================
function addToCart(id) {
  const menu = getMenu();
  const item = menu.find(p => p.id === id);
  if (!item) return;
  const existing = cart.find(i => i.id === id);
  if (existing) existing.quantity++;
  else cart.push({ id: item.id, name: item.name, price: item.price, quantity: 1 });
  updateCartCount();
  saveCart();
  showToast(`${item.name} agregado al carrito`, "success");
}

function changeQty(id, delta) {
  const item = cart.find(i => i.id === id);
  if (!item) return;
  item.quantity += delta;
  if (item.quantity <= 0) cart = cart.filter(i => i.id !== id);
  renderCart();
  updateCartCount();
  saveCart();
}

function removeFromCart(id) {
  const item = cart.find(i => i.id === id);
  cart = cart.filter(i => i.id !== id);
  renderCart();
  updateCartCount();
  saveCart();
  showToast(`${item?.name || "Producto"} eliminado del carrito`, "warning");
}

function updateCartCount() {
  const count = cart.reduce((sum, i) => sum + i.quantity, 0);
  document.getElementById("cartCount").textContent = count;
}

function saveCart() {
  localStorage.setItem("mariaChulaCart", JSON.stringify(cart));
}

function renderCart() {
  const cartItems = document.getElementById("cartItems");
  const empty = document.getElementById("emptyCart");
  const totalEl = document.getElementById("cartTotal");

  if (!cart.length) {
    cartItems.innerHTML = "";
    empty.style.display = "block";
    totalEl.textContent = "Q0.00";
    return;
  }

  empty.style.display = "none";
  let total = 0;
  cartItems.innerHTML = cart.map(i => `
    <div class="cart-item">
      <div><strong>${i.name}</strong><div>Q${i.price.toFixed(2)} x ${i.quantity}</div></div>
      <div class="cart-item-actions">
        <button class="btn ghost" onclick="changeQty(${i.id}, -1)">-</button>
        <span>${i.quantity}</span>
        <button class="btn ghost" onclick="changeQty(${i.id}, 1)">+</button>
        <button class="btn danger" onclick="removeFromCart(${i.id})"><i class="fas fa-trash"></i></button>
      </div>
    </div>
  `).join("");

  total = cart.reduce((s, i) => s + i.price * i.quantity, 0);
  totalEl.textContent = `Q${total.toFixed(2)}`;
}

function openCartModal() {
  renderCart();
  document.getElementById("cartModal").classList.add("active");
}

function closeCartModal() {
  document.getElementById("cartModal").classList.remove("active");
}

// ==============================
// PEDIDOS
// ==============================
function openOrderTypeModal() {
  if (!cart.length) return showMessage("Carrito vac√≠o", "Agrega productos antes de enviar un pedido.", "warning");
  closeCartModal();
  document.getElementById("orderTypeModal").classList.add("active");
}

function closeOrderTypeModal() {
  document.getElementById("orderTypeModal").classList.remove("active");
}

function selectOrderType(type) {
  orderType = type;
  const form = document.getElementById("clientForm");
  if (type === "mesa") {
    form.innerHTML = `
      <input id="clienteNombre" placeholder="Nombre del cliente" required>
      <input id="clienteApellido" placeholder="Apellido del cliente" required>
    `;
  } else {
    form.innerHTML = `
      <input id="clienteNombre" placeholder="Nombre" required>
      <input id="clienteApellido" placeholder="Apellido" required>
      <input id="clienteCorreo" type="email" placeholder="Correo" required>
      <input id="clienteTelefono" placeholder="Tel√©fono" required>
      <input id="clienteDireccion" placeholder="Direcci√≥n" required>
    `;
  }
  closeOrderTypeModal();
  openCartModal();
  document.querySelector('.modal-footer .primary').setAttribute('onclick', 'submitOrder()');
}

// ==============================
// ENVIAR PEDIDO (con registro de cliente)
// ==============================
async function submitOrder() {
  if (!cart.length) return showMessage("Error", "El carrito est√° vac√≠o.", "error");

  const nombre = document.getElementById("clienteNombre")?.value?.trim();
  const apellido = document.getElementById("clienteApellido")?.value?.trim();
  const correo = document.getElementById("clienteCorreo")?.value?.trim();
  const telefono = document.getElementById("clienteTelefono")?.value?.trim();
  const direccion = document.getElementById("clienteDireccion")?.value?.trim();
  const notas = document.getElementById("orderNotes").value.trim();

  if (!nombre || !apellido)
    return showMessage("Faltan datos", "Debe ingresar nombre y apellido del cliente.", "warning");
  if (orderType === "domicilio" && (!correo || !telefono || !direccion))
    return showMessage("Datos incompletos", "Complete todos los datos para pedidos a domicilio.", "warning");

  const token = localStorage.getItem("token");
  const total = cart.reduce((s, i) => s + i.price * i.quantity, 0);

  // 1Ô∏è‚É£ Registrar cliente antes del pedido
  const clienteData = { nombre, apellido, correo, telefono, direccion };

  let clienteId = null;
  try {
    const resCliente = await fetch("http://localhost:5000/clientes", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify(clienteData)
    });

    const clienteResp = await resCliente.json();
    if (!resCliente.ok) throw new Error(clienteResp.error || "Error al registrar cliente");
    clienteId = clienteResp.id_cliente;
  } catch (err) {
    console.error("Error al registrar cliente:", err);
    return showMessage("Error", "No se pudo registrar el cliente: " + err.message, "error");
  }

  // 2Ô∏è‚É£ Registrar pedido
  const pedidoData = {
    tipo_pedido: orderType,
    total,
    id_cliente: clienteId,
    detalles: cart.map(i => ({
      id_producto: i.id,
      cantidad: i.quantity,
      precio_unitario: i.price,
      subtotal: i.price * i.quantity
    })),
    notas
  };

  try {
    const res = await fetch("http://localhost:5000/pedidos", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
        "Authorization": `Bearer ${token}`
      },
      body: JSON.stringify(pedidoData)
    });
    const data = await res.json();

    if (!res.ok) throw new Error(data.error || "Error al registrar pedido");

    showMessage("√âxito", `‚úÖ Pedido enviado con √©xito (ID: ${data.id_pedido})`, "success");
    cart = [];
    saveCart();
    updateCartCount();
    closeCartModal();
  } catch (err) {
    console.error(err);
    showMessage("Error", "Error al enviar el pedido: " + err.message, "error");
  }
}

// ==============================
// INICIO
// ==============================
document.addEventListener("DOMContentLoaded", () => {
  const saved = localStorage.getItem("mariaChulaCart");
  if (saved) cart = JSON.parse(saved);
  renderMenuGrid();
  updateCartCount();
  document.getElementById("cartButton").addEventListener("click", openCartModal);
});
</script>
</body>
</html>