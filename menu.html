<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Menú - María Chula</title>
  <link rel="stylesheet" href="menu.css">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
  <link rel="icon" href="fotos/iconomch.ico" type="image/x-icon">
</head>
<body>
<div class="app">
  <aside class="sidebar">
    <div class="logo">
        <img src="fotos/logomch.png" alt="Logo María Chula">
        <h2>María Chula</h2>
    </div>
    <div class="menu-list">
      <a href="menu.html" class="menu-item"><i class="fas fa-utensils"></i> Menú</a>
      <a href="inventory.html" class="menu-item"><i class="fas fa-boxes"></i> Inventario</a>
      <a href="dashboard.html" class="menu-item"><i class="fas fa-home"></i> Dashboard</a>
      <a href="admin-menus.html" class="menu-item"><i class="fas fa-list-alt"></i> Admin Menús</a>
      <a href="admin-users.html" class="menu-item"><i class="fas fa-users"></i> Admin Usuarios</a>
      <a href="billing.html" class="menu-item"><i class="fas fa-receipt"></i> Facturación</a>
      <a href="events.html" class="menu-item"><i class="fas fa-calendar-alt"></i> Eventos</a>
      <a href="history-events.html" class="menu-item"><i class="fas fa-history"></i> Historial Eventos</a>
      <a href="history-orders.html" class="menu-item"><i class="fas fa-clipboard-list"></i> Historial Pedidos</a>
      <a href="queue.html" class="menu-item"><i class="fas fa-tasks"></i> Cola de pedidos</a>
    </div>
  </aside>

  <main class="main">
    <div class="header">
      <div class="title">Menú de Pedidos</div>
      <div class="actions">
        <a href="panel.html" class="back-button">
          <i class="fas fa-arrow-left"></i> Regresar
        </a>
      </div>
    </div>

    <div class="card">
      <div class="order-header">
        <h3>Platos disponibles</h3>
        <div class="order-actions">
          <button class="btn" onclick="openOrderTypeModal()">
            <i class="fas fa-truck"></i> Enviar pedido
          </button>
          <button id="cartToggle" class="btn primary">
            <i class="fas fa-shopping-cart"></i> Ver Carrito (<span id="cartCount">0</span>)
          </button>
        </div>
      </div>

      <div class="order-container">
        <div id="menuGrid" class="menu-grid"></div>
        
        <!-- Carrito flotante -->
        <div id="floatingCart" class="cart-container floating-cart">
          <div class="cart-header">
            <h3>Tu Pedido</h3>
            <button class="btn ghost close-cart" onclick="toggleCart()">
              <i class="fas fa-times"></i>
            </button>
          </div>
          <div class="cart-content">
            <div id="cartItems"></div>
            <div id="emptyCart" class="empty-cart">No hay items en el carrito</div>
            <div class="cart-total">Total: <span id="cartTotal">$0.00</span></div>
          </div>
          
          <div class="notes-box">
            <h3>Detalles del Pedido</h3>
            <textarea id="orderNotes" placeholder="Indica aquí cualquier detalle especial para tu pedido (alergias, modificaciones, etc.)"></textarea>
          </div>
        </div>
      </div>
    </div>
  </main>
</div>

<!-- Modal para seleccionar tipo de pedido -->
<div id="orderTypeModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3>Seleccionar tipo de pedido</h3>
      <button class="close-modal" onclick="closeOrderTypeModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p>¿Cómo será el pedido?</p>
      <div class="modal-actions">
        <button class="btn" onclick="submitOrder({type:'domicilio',address:'Dirección demo'})">
          <i class="fas fa-truck"></i> Domicilio
        </button>
        <button class="btn primary" onclick="submitOrder({type:'mesa',table:5})">
          <i class="fas fa-utensils"></i> Mesa
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de confirmación -->
<div id="confirmationModal" class="modal">
  <div class="modal-content">
    <div class="modal-header">
      <h3 id="confirmationTitle">Confirmación</h3>
      <button class="close-modal" onclick="closeConfirmationModal()">
        <i class="fas fa-times"></i>
      </button>
    </div>
    <div class="modal-body">
      <p id="confirmationMessage"></p>
      <div class="modal-actions">
        <button class="btn" onclick="closeConfirmationModal()">Cancelar</button>
        <button id="confirmAction" class="btn primary">Confirmar</button>
      </div>
    </div>
  </div>
</div>

<script>
// Variables globales
let cart = [];
let orderNotes = '';
let cartVisible = false;

// Obtener menú desde localStorage (desde admin-menus.html)
function getMenu() {
  // Intentar obtener desde localStorage primero
  const savedMenu = localStorage.getItem('mc_menu');
  
  if (savedMenu) {
    return JSON.parse(savedMenu);
  }
  
  // Si no hay menú guardado, usar datos de ejemplo
  return [
    { id: 1, name: "Tacos al Pastor", description: "Deliciosos tacos con carne adobada, piña y cilantro", price: 45, category: "comidas" },
    { id: 2, name: "Enchiladas Verdes", description: "Tortillas rellenas de pollo bañadas en salsa verde", price: 55, category: "comidas" },
    { id: 3, name: "Flan Napolitano", description: "Postre de flan con caramelo y queso crema", price: 35, category: "postres" },
    { id: 4, name: "Chilaquiles", description: "Tortillas fritas con salsa, crema y queso", price: 40, category: "antojitos" },
    { id: 5, name: "Limonada Fresca", description: "Refrescante limonada natural con hierbabuena", price: 20, category: "bebidas-frias" },
    { id: 6, name: "Café de Olla", description: "Café tradicional mexicano con piloncillo y canela", price: 18, category: "bebidas-calientes" },
    { id: 7, name: "Margarita Clásica", description: "Coctel de tequila con limón y triple sec", price: 55, category: "licores" }
  ];
}

// Función para formatear dinero
function formatMoney(amount) {
  return `Q${amount.toFixed(2)}`;
}

// Función para obtener el nombre de la categoría
function getCategoryName(category) {
  const categories = {
    'comidas': 'Comidas',
    'postres': 'Postres',
    'antojitos': 'Antojitos',
    'bebidas-frias': 'Bebidas Frías',
    'bebidas-calientes': 'Bebidas Calientes',
    'licores': 'Licores'
  };
  return categories[category] || category;
}

// Función para obtener la clase CSS de la categoría
function getCategoryClass(category) {
  return `category-${category}`;
}

// Renderizar la cuadrícula del menú
function renderMenuGrid(selector) {
  const container = document.querySelector(selector);
  const menu = getMenu();
  
  if (menu.length === 0) {
    container.innerHTML = `
      <div style="grid-column: 1 / -1; text-align: center; padding: 40px; color: var(--color-muted);">
        <i class="fas fa-utensils" style="font-size: 48px; margin-bottom: 15px;"></i>
        <h3>No hay platillos en el menú</h3>
        <p>Agrega platillos desde la sección de Administración de Menús</p>
        <a href="admin-menus.html" class="btn primary" style="margin-top: 15px;">
          <i class="fas fa-plus"></i> Agregar Platillos
        </a>
      </div>
    `;
    return;
  }
  
  container.innerHTML = menu.map(item => `
    <div class="menu-item-card" onclick="addToCart(${item.id})">
      ${item.img ? `<img src="${item.img}" alt="${item.name}" style="width: 100%; height: 150px; object-fit: cover; border-radius: 8px; margin-bottom: 10px;">` : ''}
      <span class="category ${getCategoryClass(item.category)}">${getCategoryName(item.category)}</span>
      <h4>${item.name}</h4>
      <div class="price">${formatMoney(item.price)}</div>
      <div class="description">${item.description}</div>
      <button class="btn primary">
        <i class="fas fa-plus"></i> Agregar
      </button>
    </div>
  `).join('');
}

// Toggle del carrito flotante
function toggleCart() {
  const cart = document.getElementById('floatingCart');
  cartVisible = !cartVisible;
  
  if (cartVisible) {
    cart.classList.add('active');
  } else {
    cart.classList.remove('active');
  }
}

// Actualizar contador del carrito
function updateCartCount() {
  const count = cart.reduce((total, item) => total + item.quantity, 0);
  document.getElementById('cartCount').textContent = count;
}

// Modales
function openOrderTypeModal() {
  if (cart.length === 0) {
    showConfirmation('Carrito vacío', 'No hay items en el carrito. Agrega productos antes de enviar un pedido.', false);
    return;
  }
  document.getElementById('orderTypeModal').classList.add('active');
}

function closeOrderTypeModal() {
  document.getElementById('orderTypeModal').classList.remove('active');
}

function showConfirmation(title, message, hasConfirm = true) {
  document.getElementById('confirmationTitle').textContent = title;
  document.getElementById('confirmationMessage').textContent = message;
  
  const confirmBtn = document.getElementById('confirmAction');
  if (hasConfirm) {
    confirmBtn.style.display = 'inline-flex';
  } else {
    confirmBtn.style.display = 'none';
  }
  
  document.getElementById('confirmationModal').classList.add('active');
}

function closeConfirmationModal() {
  document.getElementById('confirmationModal').classList.remove('active');
}

// Inicialización
document.addEventListener('DOMContentLoaded', () => {
  renderMenuGrid('#menuGrid');
  updateCartUI();
  
  // Cargar carrito desde localStorage si existe
  const savedCart = localStorage.getItem('mariaChulaCart');
  if(savedCart) {
    cart = JSON.parse(savedCart);
    updateCartUI();
  }
  
  // Cargar notas desde localStorage
  const savedNotes = localStorage.getItem('mariaChulaOrderNotes');
  if(savedNotes) {
    orderNotes = savedNotes;
    document.getElementById('orderNotes').value = orderNotes;
  }
  
  // Escuchar cambios en las notas
  document.getElementById('orderNotes').addEventListener('input', (e) => {
    orderNotes = e.target.value;
    localStorage.setItem('mariaChulaOrderNotes', orderNotes);
  });
  
  // Botón para toggle del carrito
  document.getElementById('cartToggle').addEventListener('click', toggleCart);
  
  // Escuchar cambios en el menú (por si se agregan platillos desde otra pestaña)
  window.addEventListener('storage', function(e) {
    if (e.key === 'mc_menu') {
      renderMenuGrid('#menuGrid');
    }
  });
});

function addToCart(itemId) {
  const menu = getMenu();
  const item = menu.find(m => m.id === itemId);
  
  if(!item) return;
  
  const existingItem = cart.find(i => i.id === itemId);
  
  if(existingItem) {
    existingItem.quantity += 1;
  } else {
    cart.push({
      id: item.id,
      name: item.name,
      price: item.price,
      quantity: 1,
      notes: ''
    });
  }
  
  saveCart();
  updateCartUI();
  
  // Mostrar el carrito automáticamente al agregar un producto
  if (!cartVisible) {
    toggleCart();
  }
}

function updateCartItem(itemId, newQty) {
  const item = cart.find(i => i.id === itemId);
  
  if(!item) return;
  
  if(newQty <= 0) {
    removeFromCart(itemId);
    return;
  }
  
  item.quantity = newQty;
  saveCart();
  updateCartUI();
}

function removeFromCart(itemId) {
  cart = cart.filter(i => i.id !== itemId);
  saveCart();
  updateCartUI();
}

function saveCart() {
  localStorage.setItem('mariaChulaCart', JSON.stringify(cart));
}

function updateCartUI() {
  const cartItemsEl = document.getElementById('cartItems');
  const emptyCartEl = document.getElementById('emptyCart');
  const cartTotalEl = document.getElementById('cartTotal');
  
  if(cart.length === 0) {
    cartItemsEl.innerHTML = '';
    emptyCartEl.style.display = 'block';
    cartTotalEl.textContent = formatMoney(0);
    updateCartCount();
    return;
  }
  
  emptyCartEl.style.display = 'none';
  
  let total = 0;
  
  cartItemsEl.innerHTML = cart.map(item => `
    <div class="cart-item">
      <div>
        <strong>${item.name}</strong>
        <div>${formatMoney(item.price)} x ${item.quantity}</div>
      </div>
      <div class="cart-item-actions">
        <button class="btn ghost" onclick="updateCartItem(${item.id}, ${item.quantity - 1})">-</button>
        <span class="cart-item-qty">${item.quantity}</span>
        <button class="btn ghost" onclick="updateCartItem(${item.id}, ${item.quantity + 1})">+</button>
        <button class="btn ghost" onclick="removeFromCart(${item.id})" style="color:var(--color-secondary)">×</button>
      </div>
    </div>
  `).join('');
  
  total = cart.reduce((sum, item) => sum + (item.price * item.quantity), 0);
  cartTotalEl.textContent = formatMoney(total);
  updateCartCount();
}

function submitOrder(orderDetails) {
  if(cart.length === 0) {
    showConfirmation('Error', 'No hay items en el carrito', false);
    return;
  }
  
  const order = {
    ...orderDetails,
    items: [...cart],
    notes: orderNotes,
    date: new Date().toISOString(),
    status: 'pending'
  };
  
  console.log('Pedido enviado:', order);
  
  // Guardar en historial de pedidos
  saveOrderToHistory(order);
  
  cart = [];
  orderNotes = '';
  saveCart();
  localStorage.removeItem('mariaChulaOrderNotes');
  document.getElementById('orderNotes').value = '';
  updateCartUI();
  closeOrderTypeModal();
  
  showConfirmation('Éxito', 'Pedido enviado con éxito!', false);
}

function saveOrderToHistory(order) {
  // Obtener pedidos existentes o inicializar array vacío
  const orders = JSON.parse(localStorage.getItem('mariaChulaOrders') || '[]');
  
  // Agregar nuevo pedido
  orders.push(order);
  
  // Guardar de vuelta en localStorage
  localStorage.setItem('mariaChulaOrders', JSON.stringify(orders));
}
</script>
</body>
</html>